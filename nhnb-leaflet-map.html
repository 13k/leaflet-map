<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="nhnb-leaflet-import.html">

<polymer-element name="nhnb-leaflet-marker" attributes="latitude longitude title">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	Polymer('nhnb-leaflet-marker', {
		publish: {
			latitude: {value: null, reflect: true},
			longitude: {value: null, reflect: true}
		},
		title: '',
		marker: undefined,

		mapChanged: function() {
			if (this.map) {
				this.marker = L.marker([this.latitude, this.longitude], {
					title: this.title
				});
				if (this.innerHTML) {
					this.marker.bindPopup(this.innerHTML);
				}
				this.marker.addTo(this.map);
			}
		}
	});
	</script>
</polymer-element>









<polymer-element name="nhnb-leaflet-map" attributes="latitude longitude zoom">
	<template>
		<link rel="stylesheet" href="../leaflet-bower/dist/leaflet.css" />
		<style>
			:host { display: block; } 
			:host #map {height:100%; width:100%}
		</style>
		<div id="map"></div>
		<content id="markers" select="nhnb-leaflet-marker"></content>
  	</template>
	<script>
	Polymer('nhnb-leaflet-map', {
		/** Publish attributes with reflection of values to attributes */
		publish: {
			latitude: {value: 51, reflect: true},
			longitude: {value: 0, reflect: true},
			zoom: {value: -1, reflect: true}
		},

		/** reference to the leaflet map */
		map: undefined,

		/** update view on attribute change */
		observe: {
			latitude: 'view',
		    longitude: 'view',
		    zoom: 'view'
		},

		view: function(oldValue, newValue) {
			if (this.map) {
				this.map.setView(L.latLng(this.latitude, this.longitude), this.zoom);
			}
		},

		domReady: function() {
			L.Icon.Default.imagePath = "../leaflet-bower/dist/images";
			this.map = L.map(this.$.map, {
				center: [this.latitude, this.longitude],
				zoom: this.zoom
            });
			if (this.zoom == -1) {
				this.map.fitWorld();
			}
			
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
				maxZoom: 18
			}).addTo(this.map);
			
			this.registerMapOnChildren();
		},

		registerMapOnChildren: function() {
			this.children = Array.prototype.slice.call(
				this.$.markers.getDistributedNodes());

			this.onMutation(this, this.registerMapOnChildren);
			for (var i = 0; i < this.children.length; i++) {
				this.children[i].map = this.map;
			}
		},
	});
    </script>
</polymer-element>