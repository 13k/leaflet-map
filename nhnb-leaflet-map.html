<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="nhnb-leaflet-import.html">

<polymer-element name="nhnb-leaflet-marker" attributes="latitude longitude title">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	Polymer('nhnb-leaflet-marker', {
		publish: {
			latitude: {value: null, reflect: true},
			longitude: {value: null, reflect: true}
		},
		title: '',
		marker: undefined,

		mapChanged: function() {
			if (this.map) {
				this.marker = L.marker([this.latitude, this.longitude], {
					title: this.title
				});
				if (this.innerHTML) {
					this.marker.bindPopup(this.innerHTML);
				}
				this.marker.addTo(this.map);
			}
		}
	});
	</script>
</polymer-element>


<polymer-element name="nhnb-leaflet-tile-layer" attributes="src min-zoom max-zoom no-wrap max-native-zoom tile-size subdomains error-tile-url attribution tms continuous-world no-wrap zoom-offset zoom-reverse opacity z-index detect-retina reuse-tiles">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	Polymer('nhnb-leaflet-tile-layer', {
		src: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
		"min-zoom": 0,
		"max-zoom": 18,
		"max-native-zoom": null,
		"tile-size": 256,
		"subdomains": "abc",
		"error-tile-url": "",
		"attribution": "",
		"tms": false,
		"continuous-world": false,
		"no-wrap": false,
		"zoom-offset": 0,
		"zoom-reverse": false,
		"opacity": 1.0,
		"z-index": null,
		"detect-retina": false,
		"reuse-tiles": false,
		// unloadInvisibleTiles updateWhenIdle bounds
		
		mapChanged: function() {
			if (this.map) {
				this.layer = L.tileLayer(this.src, {
					attribution: this.innerHTML + this['attribution'],
					minZoom: this['min-zoom'],
					maxZoom: this['max-zoom'],
					maxNativeZoom: this['max-native-zoom'],
					tileSize: this['tile-size'],
					subdomains: this['subdomains'],
					errorTileUrl: this['error-tile-url'],
					tms: this['tms'],
					continuousWorld: this['continuous-world'],
					noWrap: this['no-wrap'],
					zoomOffset: this['zoom-offset'],
					zoomReverse: this['zoom-reverse'],
					opacity: this['opacity'],
					zIndex: this['z-index'],
					detectRetina: this['detect-retina'],
					reuseTiles: this['reuse-tiles'],
				});
				this.layer.addTo(this.map);
			}
		}
	});
	</script>
</polymer-element>






<polymer-element name="nhnb-leaflet-map" attributes="latitude longitude zoom">
	<template>
		<link rel="stylesheet" href="../leaflet-bower/dist/leaflet.css" />
		<style>
			:host { display: block; } 
			:host #map {height:100%; width:100%}
		</style>
		<div id="map"></div>
		<content id="markers" select="nhnb-leaflet-marker nhnb-leaflet-tile-layer"></content>
  	</template>
	<script>
	Polymer('nhnb-leaflet-map', {
		/** Publish attributes with reflection of values to attributes */
		publish: {
			latitude: {value: 51, reflect: true},
			longitude: {value: 0, reflect: true},
			zoom: {value: -1, reflect: true}
		},

		/** reference to the leaflet map */
		map: undefined,

		/** update view on attribute change */
		observe: {
			latitude: 'view',
		    longitude: 'view',
		    zoom: 'view'
		},

		view: function(oldValue, newValue) {
			if (this.map) {
				this.map.setView(L.latLng(this.latitude, this.longitude), this.zoom);
			}
		},

		domReady: function() {
			L.Icon.Default.imagePath = "../leaflet-bower/dist/images";
			this.map = L.map(this.$.map, {
				center: [this.latitude, this.longitude],
				zoom: this.zoom
            });
			if (this.zoom == -1) {
				this.map.fitWorld();
			}

			var defaultLayerRequired = true;
			for (var i = 0; i < this.children.length; i++) {
				var localName = this.children[i].localName;
				if (localName.indexOf("-layer", localName.length - 6) !== -1) {
					defaultLayerRequired = false;
				}
			}
			if (defaultLayerRequired) {
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
					maxZoom: 18
				}).addTo(this.map);
			}
			
			this.registerMapOnChildren();
		},

		registerMapOnChildren: function() {
			for (var i = 0; i < this.children.length; i++) {
				this.children[i].map = this.map;
			}
			this.onMutation(this, this.registerMapOnChildren);
		},
	});
    </script>
</polymer-element>