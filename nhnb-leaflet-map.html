<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="nhnb-leaflet-import.html">

<polymer-element name="nhnb-leaflet-marker" attributes="latitude longitude clickable dragable title alt zindexoffset opacity riseonhover riseoffset">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	Polymer('nhnb-leaflet-marker', {
		publish: {
			latitude: {value: null, reflect: true},
			longitude: {value: null, reflect: true}
		},
		// icon
		clickable: true,
		dragable: false,
		title: '',
		alt: '',
		zindexoffset: 0,
		opacity: 1.0,
		riseonhover: false,
		riseoffset: 250,
		marker: undefined,

		observe: {
			latitude: 'positionChanged',
		    longitude: 'positionChanged',
		},

		mapChanged: function() {
			if (this.map) {
				this.marker = L.marker([this.latitude, this.longitude], {
					clickable: this.clickable,
					dragable: this.dragable,
					title: this.title,
					alt: this.alt,
					zindexoffset: this.zindexoffset,
					opacity: this.opacity,
					riseonhover: this.riseonhover,
					riseoffset: this.riseoffset,
				});
				if (this.innerHTML) {
					this.marker.bindPopup(this.innerHTML);
				}
				this.marker.addTo(this.map);
			}
		},

		positionChanged: function() {
			if (this.marker) {
				this.marker.setLatLng(L.LatLng(this.latitude, this.longitude));
			}
		},

		zindexoffsetChanged: function() {
			if (this.marker) {
				this.marker.setZIndexOffset(this.zindex);
			}
		},

		opacityChanged: function() {
			if (this.marker) {
				this.marker.setOpacity(this.opacity);
			}
		},

// setIcon( <Icon> icon ) 	this 	Changes the marker icon.
// setPopupContent( <String> html | <HTMLElement> el, <Popup options> options? ) 	this 	Sets an HTML content of the popup of this marker.
		
	});
	</script>
</polymer-element>



<polymer-element name="nhnb-leaflet-tile-layer" attributes="url minzoom maxzoom nowrap maxnativezoom tilesize subdomains errortileurl attribution tms continuous-world nowrap zoomoffset zoomreverse opacity zindex detectretina reusetiles">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	Polymer('nhnb-leaflet-tile-layer', {
		url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
		minzoom: 0,
		maxzoom: 18,
		maxnativezoom: null,
		tilesize: 256,
		subdomains: "abc",
		errortileurl: "",
		attribution: "",
		tms: false,
		continuousworld: false,
		nowrap: false,
		zoomoffset: 0,
		zoomreverse: false,
		opacity: 1.0,
		zindex: null,
		detectretina: false,
		reusetiles: false,
		// unloadInvisibleTiles updateWhenIdle bounds
		
		mapChanged: function() {
			if (this.map) {
				this.layer = L.tileLayer(this.url, {
					attribution: this.innerHTML + this.attribution,
					minZoom: this.minzoom,
					maxZoom: this.maxzoom,
					maxNativeZoom: this.maxnativezoom,
					tileSize: this.tilesize,
					subdomains: this.subdomains,
					errorTileUrl: this.errortileurl,
					tms: this.tms,
					continuousWorld: this.continuousworld,
					noWrap: this.nowrap,
					zoomOffset: this.zoomoffset,
					zoomReverse: this.zoomreverse,
					opacity: this.opacity,
					zIndex: this.zindex,
					detectRetina: this.detectretina,
					reuseTiles: this.reusetiles,
				});
				this.layer.addTo(this.map);
			}
		},

		opacityChanged: function() {
			if (this.layer) {
				this.layer.setOpacity(this.opacity);
			}
		},
		zindexChanged: function() {
			if (this.layer) {
				this.layer.setZIndex(this.zindex);
			}
		},
		urlChanged: function() {
			if (this.layer) {
				this.layer.setUrl(this.url);
			}
		}
	});
	</script>
</polymer-element>






<polymer-element name="nhnb-leaflet-map" attributes="latitude longitude zoom">
	<template>
		<link rel="stylesheet" href="../leaflet-bower/dist/leaflet.css" />
		<style>
			:host { display: block; } 
			:host #map {height:100%; width:100%}
		</style>
		<div id="map"></div>
		<content id="markers" select="nhnb-leaflet-marker nhnb-leaflet-tile-layer"></content>
  	</template>
	<script>
	Polymer('nhnb-leaflet-map', {
		/** Publish attributes with reflection of values to attributes */
		publish: {
			latitude: {value: 51, reflect: true},
			longitude: {value: 0, reflect: true},
			zoom: {value: -1, reflect: true}
		},

		/** reference to the leaflet map */
		map: undefined,

		/** update view on attribute change */
		observe: {
			latitude: 'view',
		    longitude: 'view',
		    zoom: 'view'
		},

		view: function(oldValue, newValue) {
			if (this.map) {
				this.map.setView(L.latLng(this.latitude, this.longitude), this.zoom);
			}
		},

		domReady: function() {
			L.Icon.Default.imagePath = "../leaflet-bower/dist/images";
			this.map = L.map(this.$.map, {
				center: [this.latitude, this.longitude],
				zoom: this.zoom
            });
			if (this.zoom == -1) {
				this.map.fitWorld();
			}

			var defaultLayerRequired = true;
			for (var i = 0; i < this.children.length; i++) {
				var localName = this.children[i].localName;
				if (localName.indexOf("-layer", localName.length - 6) !== -1) {
					defaultLayerRequired = false;
				}
			}
			if (defaultLayerRequired) {
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',
					maxZoom: 18
				}).addTo(this.map);
			}
			
			this.registerMapOnChildren();
		},

		registerMapOnChildren: function() {
			for (var i = 0; i < this.children.length; i++) {
				this.children[i].map = this.map;
			}
			this.onMutation(this, this.registerMapOnChildren);
		},
	});
    </script>
</polymer-element>